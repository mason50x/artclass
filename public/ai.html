<!DOCTYPE html>
<html>
  <head>
    <link
      rel="preload"
      href="./assets/images/artclass_logo.png"
      as="image"
      type="image/png"
    />
    <link rel="icon" href="./assets/images/artclass_logo.png" type="image/png" />
    <link
      rel="shortcut icon"
      href="./assets/images/artclass_logo.png"
      type="image/png"
    />
    <title>Art Class - AI Chat</title>

    <link rel="stylesheet" href="./css/master.css" />
    <link rel="stylesheet" href="./css/main.css" />
    <script src="./js/auth.js"></script>
    <script src="./js/preload.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
    <style>
      .chat-container { max-width: 900px; margin: 80px auto 40px; padding: 0 16px; }
      .chat-box { height: 60vh; overflow-y: auto; padding: 16px; }

      .thinking-container { margin: 8px 0; }
      .thinking-header { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: rgba(79, 70, 229, 0.1); border-radius: 8px; border: 1px solid rgba(79, 70, 229, 0.2); }
      .thinking-header:hover { background: rgba(79, 70, 229, 0.15); }
      .thinking-toggle { font-size: 12px; opacity: 0.8; transition: transform 0.2s ease; }
      .thinking-toggle.expanded { transform: rotate(90deg); }
      .thinking-content { background: rgba(79, 70, 229, 0.05); border: 1px solid rgba(79, 70, 229, 0.1); border-radius: 0 0 8px 8px; padding: 12px; margin-top: -1px; max-height: 200px; overflow-y: auto; }
      .thinking-content p { margin: 0; opacity: 0.9; line-height: 1.4; }

      .loading-state { display: flex; align-items: center; gap: 8px; opacity: 0.7; }
      .loading-spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .loading-msg { animation: pulse 2s infinite; }
      @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
      .msg { display: flex; gap: 10px; margin-bottom: 12px; }
      .msg .role { font-weight: 600; opacity: 0.9; min-width: 64px; text-align: left; color: rgba(255, 255, 255, 0.8); }
      .msg .content { white-space: pre-wrap; line-height: 1.5; opacity: 1; text-align: left; color: white; }
      .msg .content :is(h1, h2, h3, h4, h5, h6) { margin: 0.5em 0; font-weight: bold; }
      .msg .content h1 { font-size: 1.2em; }
      .msg .content h2 { font-size: 1.1em; }
      .msg .content h3 { font-size: 1.05em; }
      .msg .content code { background: rgba(255,255,255,0.15); padding: 2px 4px; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.9em; }
      .msg .content pre { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 6px; overflow-x: auto; margin: 8px 0; }
      .msg .content pre code { background: none; padding: 0; font-size: 0.85em; line-height: 1.4; }
      .msg .content blockquote { border-left: 3px solid rgba(79, 70, 229, 0.5); padding-left: 12px; margin: 8px 0; opacity: 0.9; }
      .msg .content ul, .msg .content ol { margin: 8px 0; padding-left: 20px; }
      .msg .content li { margin: 4px 0; }
      .msg .content table { border-collapse: collapse; width: 100%; margin: 8px 0; }
      .msg .content th, .msg .content td { border: 1px solid rgba(255,255,255,0.15); padding: 6px 12px; text-align: left; }
      .msg .content th { background: rgba(255,255,255,0.05); }
      .msg .content a { color: #4F46E5; text-decoration: underline; }
      .msg .content a:hover { opacity: 0.8; }
      .msg .content p { margin: 8px 0; }
      .msg .content hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 12px 0; }
      .input-row { display: flex; gap: 8px; margin-top: 12px; }
      .input-row textarea { flex: 1; resize: vertical; min-height: 44px; max-height: 160px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 10px 12px; font-family: inherit; }
      .input-row button { white-space: nowrap; }
    </style>
  </head>
  <body>
    <nav>
      <div class="logo">
        <a href="/">
          <img src="./assets/images/artclass_logo.png" alt="Logo" draggable="false" />
          <h1>Art Class</h1>
        </a>
      </div>
      <p id="time"></p>
      <div class="navitems">
        <div class="navitem"><a href="/">Home</a></div>
        <div class="navitem"><a href="/gs.html">Games</a></div>
        <div class="navitem"><a href="/apps.html">Apps</a></div>
        <div class="navitem"><a href="/search.html">Search</a></div>
        <div class="navitem"><a href="/settings.html">Settings</a></div>
      </div>
    </nav>

    <div class="chat-container">
      <h1>AI Chat</h1>

      <div id="chat" class="chat-box"></div>

      <div class="input-row">
        <textarea id="message" placeholder="Ask anything for homework help..."></textarea>
        <button id="send" class="action-button modern-btn">Send</button>
      </div>
    </div>

    <script>
      // Initialize markdown renderer with better configuration
      let md = null;
      if (typeof window !== 'undefined' && window.markdownit) {
        md = window.markdownit({
          html: true, // Allow HTML tags in markdown
          linkify: true, // Convert URLs to links
          typographer: true, // Smart quotes, etc.
          breaks: true, // Convert \n to <br>
        });
        console.log('✅ Markdown support loaded successfully');
      } else {
        console.warn('⚠️ Markdown renderer not available, responses will be plain text');
      }

      const chatEl = document.getElementById('chat');
      const inputEl = document.getElementById('message');
      const sendBtn = document.getElementById('send');

      /**
       * Minimal chat state kept in memory
       */
      const messages = [
        { role: 'system', content: 'You are a concise, friendly study helper. Provide clear steps and avoid doing anything unsafe.' }
      ];

      function addMessage(role, content, thinking = null) {
        const row = document.createElement('div');
        row.className = 'msg';
        const roleEl = document.createElement('div');
        roleEl.className = 'role';
        roleEl.textContent = role === 'user' ? 'You' : role === 'assistant' ? 'AI' : 'System';
        const contentEl = document.createElement('div');
        contentEl.className = 'content';

        // Use markdown rendering for AI messages, plain text for user/system
        if (role === 'assistant' && md && content) {
          try {
            contentEl.innerHTML = md.render(content);
          } catch (e) {
            console.warn('Markdown rendering failed, using plain text:', e);
            contentEl.textContent = content;
          }
        } else {
          contentEl.textContent = content;
        }

        row.appendChild(roleEl);
        row.appendChild(contentEl);

        // Add thinking dropdown if thinking content is provided
        if (role === 'assistant' && thinking && thinking.trim()) {
          const thinkingContainer = document.createElement('div');
          thinkingContainer.className = 'thinking-container';

          const thinkingHeader = document.createElement('div');
          thinkingHeader.className = 'thinking-header';
          thinkingHeader.innerHTML = `
            <span class="thinking-toggle">▶</span>
            <span style="opacity: 0.9;">AI Reasoning</span>
          `;

          const thinkingContent = document.createElement('div');
          thinkingContent.className = 'thinking-content';
          thinkingContent.innerHTML = `<p>${thinking.replace(/\n/g, '<br>')}</p>`;

          // Toggle thinking content
          thinkingHeader.addEventListener('click', () => {
            const toggle = thinkingHeader.querySelector('.thinking-toggle');
            const isExpanded = toggle.classList.contains('expanded');
            if (isExpanded) {
              toggle.classList.remove('expanded');
              thinkingContent.style.display = 'none';
              toggle.textContent = '▶';
            } else {
              toggle.classList.add('expanded');
              thinkingContent.style.display = 'block';
              toggle.textContent = '▼';
            }
          });

          thinkingContent.style.display = 'none'; // Start collapsed
          thinkingContainer.appendChild(thinkingHeader);
          thinkingContainer.appendChild(thinkingContent);
          row.appendChild(thinkingContainer);
        }

        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function addLoadingMessage() {
        const row = document.createElement('div');
        row.className = 'msg loading-msg';
        const roleEl = document.createElement('div');
        roleEl.className = 'role';
        roleEl.textContent = 'AI';
        const contentEl = document.createElement('div');
        contentEl.className = 'content loading-state';
        contentEl.innerHTML = '<div class="loading-spinner"></div><span>Thinking...</span>';
        row.appendChild(roleEl);
        row.appendChild(contentEl);
        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
        return row;
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;
        inputEl.value = '';
        messages.push({ role: 'user', content: text });
        addMessage('user', text);

        // Add loading message
        const loadingRow = addLoadingMessage();
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending…';

        try {
          const res = await fetch('/api/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            // Remove loading message and show error
            loadingRow.remove();
            addMessage('assistant', `Error: ${data.error || 'Request failed'}`);
          } else {
            // Remove loading message
            loadingRow.remove();

            const choice = data.choices && data.choices[0];
            if (choice && choice.message) {
              const reply = choice.message.content || '(no response)';
              const thinking = choice.message.reasoning || null;

              messages.push({ role: 'assistant', content: reply });
              addMessage('assistant', reply, thinking);
            } else {
              addMessage('assistant', 'No response received.');
            }
          }
        } catch (e) {
          // Remove loading message and show error
          loadingRow.remove();
          addMessage('assistant', 'Network error contacting AI.');
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send';
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
  </html>


