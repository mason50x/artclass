<!DOCTYPE html>
<html>
  <head>
    <link
      rel="preload"
      href="./assets/images/logo.png"
      as="image"
      type="image/png"
    />
    <link rel="icon" href="./assets/images/logo.png" type="image/png" />
    <link
      rel="shortcut icon"
      href="./assets/images/logo.png"
      type="image/png"
    />
    <title>Infinite</title>

    <link rel="stylesheet" href="./css/master.css" />
    <script src="./js/auth.js"></script>
    <script src="/uv/uv.bundle.js" charset="UTF-8"></script>
    <script src="/uv/uv.config.js"></script>
    <script src="./js/preload.js"></script>
  </head>

  <body>
    <canvas id="constellation-canvas"></canvas>
    <nav>
      <div class="logo">
        <a href="/">
          <img src="./assets/images/logo.png" alt="Logo" draggable="false" />
          <h1>Infinite</h1>
        </a>
      </div>

      <p id="time"></p>

      <div class="navitems">
        <div class="navitem"><a href="/"><i class="fas fa-home"></i> Home</a></div>
        <div class="navitem"><a href="/gs.html"><i class="fas fa-gamepad"></i> Games</a></div>
        <div class="navitem"><a selected href="/apps.html"><i class="fas fa-th"></i> Apps</a></div>
        <div class="navitem"><a href="/search.html"><i class="fas fa-search"></i> Search</a></div>
        <div class="navitem"><a href="/settings.html"><i class="fas fa-cog"></i> Settings</a></div>
      </div>
    </nav>

    <h1>Apps</h1>
    <div
      class="search-container"
      style="position: relative; display: inline-block"
    >
      <input
        type="text"
        class="input"
        id="search"
        placeholder="Search Apps"
        style="text-align: center"
        autocomplete="off"
        aria-label="Search for apps"
      />
      <div
        id="suggestions"
        class="suggestions-dropdown"
        style="display: none"
      ></div>
    </div>
    <div class="cardgroup" id="appcards"></div>
  </body>

  <script src="./js/index.js"></script>
  <script src="./assets/data/apps.js"></script>
  <script src="./js/apps.js"></script>
  <script src="./js/constellations.js"></script>

  <style>
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #111;
      border: 1px solid #333;
      border-radius: 15px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 2px;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }

    .suggestions-dropdown::-webkit-scrollbar {
      display: none; /* WebKit */
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      color: white;
      border-bottom: 1px solid #333;
      transition: all 0.3s ease;
      gap: 12px;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background-color: #0284d4;
      border-radius: 8px;
      margin: 2px 4px;
      border-bottom: 1px solid transparent;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-favicon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .suggestion-text {
      flex: 1;
      font-size: 14px;
    }

    .search-container {
      width: 500px;
    }
  </style>

  <script>
    const searchInput = document.querySelector("#search");
    const suggestionsContainer = document.querySelector("#suggestions");
    const items = document.querySelectorAll(".card");
    let currentHighlight = -1;
    let allApps = [];

    // Wait for apps to load, then extract app data
    setTimeout(() => {
      allApps = apps; // Use the apps array from apps.js
    }, 100);

    function showSuggestions(query) {
      if (!query.trim()) {
        hideSuggestions();
        return;
      }

      const matches = allApps
        .filter((app) => app.title.toLowerCase().includes(query.toLowerCase()))
        .slice(0, 5); // Limit to 5 suggestions

      if (matches.length === 0) {
        hideSuggestions();
        return;
      }

      suggestionsContainer.innerHTML = matches
        .map(
          (app, index) => `
        <div class="suggestion-item" data-index="${index}">
          <img class="suggestion-favicon" src="${app.image}" alt="${app.title}" onerror="this.src='./assets/images/logo.png'">
          <span class="suggestion-text">${app.title}</span>
        </div>
      `
        )
        .join("");

      suggestionsContainer.style.display = "block";
      currentHighlight = -1;
    }

    function hideSuggestions() {
      suggestionsContainer.style.display = "none";
      currentHighlight = -1;
    }

    function highlightSuggestion(index) {
      const suggestions =
        suggestionsContainer.querySelectorAll(".suggestion-item");
      suggestions.forEach((item, i) => {
        item.classList.toggle("highlighted", i === index);
      });
      currentHighlight = index;
    }

    function selectSuggestion(title) {
      searchInput.value = title;
      hideSuggestions();

      // Find the app and launch it
      const app = apps.find((a) => a.title === title);
      if (app) {
        window.location.href = `/load.html?app=${app.id}`;
      } else {
        filterApps(title);
      }
    }

    function filterApps(query) {
      const lowerQuery = query.toLowerCase();

      items.forEach(function (item) {
        const title = item.querySelector(".card h4").textContent.toLowerCase();

        if (title.includes(lowerQuery)) {
          item.style.display = "block";
        } else {
          item.style.display = "none";
        }
      });
    }

    // Event listeners
    searchInput.addEventListener("input", function (event) {
      const query = event.target.value;
      showSuggestions(query);
      filterApps(query);
    });

    searchInput.addEventListener("keydown", function (event) {
      const suggestions =
        suggestionsContainer.querySelectorAll(".suggestion-item");

      if (event.key === "ArrowDown") {
        event.preventDefault();
        if (currentHighlight < suggestions.length - 1) {
          highlightSuggestion(currentHighlight + 1);
        }
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        if (currentHighlight > 0) {
          highlightSuggestion(currentHighlight - 1);
        }
      } else if (event.key === "Enter") {
        event.preventDefault();
        if (currentHighlight >= 0 && suggestions[currentHighlight]) {
          const title =
            suggestions[currentHighlight].querySelector(
              ".suggestion-text"
            ).textContent;
          selectSuggestion(title);
        }
      } else if (event.key === "Escape") {
        hideSuggestions();
      }
    });

    suggestionsContainer.addEventListener("click", function (event) {
      const suggestionItem = event.target.closest(".suggestion-item");
      if (suggestionItem) {
        const title =
          suggestionItem.querySelector(".suggestion-text").textContent;
        selectSuggestion(title);
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener("click", function (event) {
      if (!event.target.closest(".search-container")) {
        hideSuggestions();
      }
    });
  </script>
</html>
